<!DOCTYPE>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no">
	<meta content="telephone=no" name="format-detection">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<title>编辑测试</title>
</head>
<body>
	<style>
		img { max-width: 100%;}
	</style>
	<div class="toptilline">
		<a href="javascript:;" class="tl_back" id="J_back"></a>
		<p class="tl_til">编辑测试</p>
	</div>
	<div class="html">
		<input type="file" id="file" />
		<div style="min-height:300px; border: 1px solid #aaa; margin: 10px;padding: 10px;-webkit-user-select: auto;user-select: all;" contenteditable="true" class="test" id="a">
		</div>
	</div>
	<script type="text/javascript">

		function fileToBase64(file) {
			const reader = new FileReader();
			return new Promise((resolve, reject) => {
				reader.addEventListener("load", () => resolve(reader.result));
				reader.readAsDataURL(file);
			});
		}

		function insertNodeAtNodea(html){
			if (lastrange) {
				let range = lastrange
				range.deleteContents();
				// Range.createContextualFragment() would be useful here but is
				// non-standard and not supported in all browsers (IE9, for one)
				var el = document.createElement("div");
				el.innerHTML = html;
				// var frag = document.createDocumentFragment(), node, lastNode;
				// while ((node = el.firstChild)) {
				// 	lastNode = frag.appendChild(node);
				// }
				range.insertNode(el);
				// Preserve the selection
				if (el) {
					range = range.cloneRange();
					range.setStartAfter(el);
					range.collapse(true);
					selectnode.removeAllRanges();
					selectnode.addRange(range);
				}
			} else {
				var el = document.createElement("div");
				el.innerHTML = html;
				box.appendChild(el)
			}
		}
		let selectnode, lastrange;
		let file = document.getElementById('file')
		let box = document.getElementById('a')
		file.addEventListener('change', function(e){
			fileToBase64(e.target.files[0]).then(rs=>{
				insertNodeAtNodea('<img src="'+rs+'">')
			})
		})
		box.addEventListener('click', function(event){
			lastrange = document.caretRangeFromPoint(event.clientX, event.clientY);
		})
		box.addEventListener('input',function(){
			selectnode = window.getSelection();
			lastrange = selectnode.getRangeAt(0)
		})

		// $('#a').on('click',function(event){
				
		// 		// selectnode = window.getSelection();
		// 		lastrange = document.caretRangeFromPoint(event.clientX, event.clientY);
		// 		// lastrange = selectnode.getRangeAt(0)
		// 		// if (!selectnode.range) {
		// 		// 	selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
		// 		// }
		// 			console.log(89,selectnode)
		// 		}).on('blur',function(){
		// 			console.log('blur')
		// 		}).on('input',function(event){
		// 			// console.log(3,event)
		// 			// selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
		// 			selectnode = window.getSelection();
		// 			lastrange = selectnode.getRangeAt(0)
		// 			console.log(3,selectnode.getRangeAt(0))
		// 		})
		// $(function(){

			// $('#file').on('change',function(e){
				
				
				// console.log(e.target.files[0])
				// let div = document.createElement('div')
				// div.innerHTML = 'adsfasdf'
				// // 
				// // console.log(window.getSelection())
				// let sel = window.getSelection();
				// let range = sel.getRangeAt(0);
				// range.deleteContents();
				// range.insertNode(div)
			// })

			
			// $('#a').on('click',function(event){
				
			// 	// selectnode = window.getSelection();
			// 	selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
			// 	// if (!selectnode.range) {
			// 	// 	selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
			// 	// }
			// 		console.log(89,selectnode,event)
			// }).on('blur',function(){
			// 	console.log('blur')
			// }).on('input',function(event){
			// 	// selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
			// 	// selectnode = window.getSelection();
			// 	// console.log(selectnode)
			// })

			// $('#a').on('click',function(event){
				
			// 		// selectnode = window.getSelection();
			// 		selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
			// 		// if (!selectnode.range) {
			// 		// 	selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
			// 		// }
			// 			console.log(89,selectnode)
			// 	}).on('blur',function(){
			// 		console.log('blur')
			// 	}).on('input',function(event){
			// 		// console.log(3,event)
			// 		// selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
			// 		selectnode = window.getSelection();
			// 		console.log(3,selectnode)
			// 	})

				// document.onselectionchange = () => {

				// 	let text = window.getSelection()

				// 	console.log(33,text)

				// };

				// $('#a').on('click',function(event){
				
				// // selectnode = window.getSelection();
				// lastrange = document.caretRangeFromPoint(event.clientX, event.clientY);
				// // lastrange = selectnode.getRangeAt(0)
				// // if (!selectnode.range) {
				// // 	selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
				// // }
				// 	console.log(89,selectnode)
				// }).on('blur',function(){
				// 	console.log('blur')
				// }).on('input',function(event){
				// 	// console.log(3,event)
				// 	// selectnode = document.caretRangeFromPoint(event.clientX, event.clientY);
				// 	selectnode = window.getSelection();
				// 	lastrange = selectnode.getRangeAt(0)
				// 	console.log(3,selectnode.getRangeAt(0))
				// })
			
		// });

	</script>
</body>
</html>
