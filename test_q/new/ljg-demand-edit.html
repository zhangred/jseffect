<!DOCTYPE>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no">
	<meta content="telephone=no" name="format-detection">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link href="./assets/css/style.css?v=1.1" rel="stylesheet" type="text/css" />
	<script language="javascript" type="text/javascript" src="./assets/js/size.js"></script>
	<title>发布需求</title>
</head>
<body>
	<style>
		.html{ padding-bottom: .7rem;}
		.form-botline { position: fixed; left: 0; bottom: 0; right: 0; z-index: 3; background-color: #fff; padding: .1rem .14rem; border-top: 1px solid #eee;}
		.form-botline .fbl-btn { line-height: .36rem; font-size: .14rem;}
		.mt10{ margin-top: .1rem;}
		.tipa { font-size: .12rem; color: #999;}
	</style>
	<div class="html">
		<div class="cm-form">
			<div class="fline">
				<div class="fl-ao">标题<span class="fl-ao-star">*</span></div>
				<div class="fl-input-warp"><input class="J_input J_blurscroll fl-input" data-key="title" placeholder="请填写资源名称" /></div>
			</div>
			<div class="fline">
				<div class="fl-ao flex-aic-jcsb">
					<div>需求类型<span class="fl-ao-star">*</span></div>
					<span class="tipa">请选择标签，最多可选3项</span>
				</div>
				<div class="fl-check-btns">
					<div data-type="1" class="J_type fl-check-btn">投资</div>
					<div data-type="2" class="J_type fl-check-btn">投资01</div>
					<div data-type="3" class="J_type fl-check-btn">互联网</div>
					<div data-type="4" class="J_type fl-check-btn">健康</div>
					<div data-type="5" class="J_type fl-check-btn">健康01</div>
					<div data-type="6" class="J_type fl-check-btn">健康02</div>
				</div>
			</div>
			<div class="fline">
				<div class="fl-ao">截止日期<span class="fl-ao-star">*</span></div>
				<div class="J_timepicker fl-input-warp fl-select" data-title="截止日期" data-timegroup="y-m-d" data-format="y/m/d"><input class="fl-input" id="J_input_customer" placeholder="请选择日期，最长展示3个月" /></div>
			</div>
		</div>

		<div class="cm-form mt10">
			<div class="fline">
				<div class="fl-ao flex-aic-jcsb">
					<div>需求详情<span class="fl-ao-star">*</span></div>
					<div class="fl-ao-add flex-aic"><i class="fl-ao-ico iconfont icon-tupian1"></i>添加图片<input class="fl-ao-file" type="file" id="J_file_content" /></div>
				</div>
				<div class="fl-edit-warp">
					<textarea class="fl-edit-holder" placeholder="请详细描述您的合作需求" id="J_holder_content" ></textarea>
					<div class="J_blurscroll fl-edit-content" contenteditable="true" id="J_container_content"></div>
				</div>
			</div>
		</div>

		<div class="cm-form mt10">
			<div class="fline">
				<div class="fl-ao flex-aic-jcsb">上传需求封面<span class="fl-ao-star">*</span></div>
				<div class="fl-upload-warp" id="J_upload_warp">
					<div class="fl-upload-add" id="J_dom_cover"><input type="file" accept="image/*" id="J_upfild" class="fl-upfile" /><i class="fl-upadd-ico iconfont icon-plus01"></i></div>
					<!-- <div class="fl-upload-pic"><img src="./img/img02.jpg" class="fl-upload-img" /><a href="javascript:;" class="fl-upload-clear"></a></div> -->
				</div>
			</div>
		</div>

		<!-- 提交按钮 -->
		<div class="form-botline">
			<a href="javascript:;" class="fbl-btn cm-btn" id="J_save">提交</a>
		</div>
	</div>
	<script language="javascript" type="text/javascript" src="./assets/js/jquery-2.1.4.min.js"></script>
	<script language="javascript" type="text/javascript" src="./assets/js/common.js"></script>
	<script type="text/javascript">
		$(function(){
			let J_html = $('#J_html')
			// 预定义提交参数
			let params = {
				type: [], // 需求类型 默认 []
			}

			// 绑定输入
			$('.J_input').on('input',function(){
				let val = $(this).val().trim()
				let key = $(this).attr('data-key')
				params[key] = val;
			})

			// 类型选择
			$('.J_type').click(function(){
				let self = $(this)
				let type = self.attr('data-type')
				let idx = params.type.indexOf(type)
				if (idx>-1) {
					self.removeClass('active')
					params.type.splice(idx,1)
				} else {
					if (params.type.length>=3) {
						CUES.tip({msg: '最多可选3项'})
						return
					}
					self.addClass('active')
					params.type.push(type)
				}
			})

			// 上传封面图
			let J_dom_cover = $('#J_dom_cover')
			$('#J_upfild').change(function(e){
				var self = $(this)
				CUES.loading({msg: '上传中···'})
				// 模拟上传图片，返回url
				setTimeout(()=>{
					CUES.loadingclose()
					var url = 'http://lianjia.biaotu.net/img03.jpeg';
					params.cover_url = url;
					J_dom_cover.hide()
					J_dom_cover.before(`<div class="fl-upload-pic"><img src="./img/img02.jpg" data-origin="./img/img02.jpg" class="fl-upload-img" /><a href="javascript:;" class="fl-upload-clear"></a></div>`)
				},500)
			})

			$('#J_upload_warp').on('click', '.fl-upload-clear',function(){
				// 删除封面图
				let self = $(this)
				CUES.confirm({"msg":"确定要删除该图片吗？","callback":function(r){
					if(r){
						params.cover_url = null;
						self.parent().remove()
						J_dom_cover.show()
					}
				}})
			})

			// 初始化资源内容图文混编
			new editContenteditable({
				upfileId: 'J_file_content',
				containerId: 'J_container_content',
				holderIdL:'J_holder_content',
				onChange: function(rs){
					params.content = rs
				}
			})

			// 时间选择
			new datePicker({
                "targets":document.getElementsByClassName('J_timepicker'),
                // "minyear":1960,
                "confirm":function(rs,cb){
					var tar = $(rs.target)
					// 可在tar上获取想要的数据 cb是确认选择关闭弹框的回调 不执行则不关闭
					if (rs.time.getTime()>new Date().getTime() + 90 * 24 * 3600 * 1000) {
						CUES.tip({msg: `时间不可超过${new eTime().shifting('date', 90).format('YYYY-MM-DD')}`})
						return;
					}
                    $(rs.target).find('input').val(rs.time_str)
                    cb();
					params.time_end = new eTime(rs.time).format('YYYY-MM-DD')
                }
            })

			// 保存提交
			$('#J_save').click(function(){
				console.log('params',params)
				if (!params.title) {
					CUES.tip({msg: '请输入资源名称'})
					return
				}
				if (params.type.length==0) {
					CUES.tip({msg: '请选择需求类型'})
					return
				}
				if (!params.time_end) {
					CUES.tip({msg: '请选择日期'})
					return
				}
				if (!params.content) {
					CUES.tip({msg: '请填写详细描述您的合作需求'})
					return
				}
				J_html.addClass('noEvent')
				CUES.loading({msg:'正在保存，请稍等...'})
				$.ajax({
					type: "GET",
					url: "../api/callback.json?v="+(new Date().getTime()),
					data: {},
					dataType: "json",
					success: function(res){
						if(res.code==0){
							CUES.loadingclose()
							CUES.tip({msg:'保存成功',type:'success',callback:function(){
								// do
							}})
						}
					},
					complete: function(){
						J_html.removeClass('noEvent')
					}
				});
			})

			
			
		});
	</script>
</body>
</html>
