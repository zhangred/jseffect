<!DOCTYPE>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no">
	<meta content="telephone=no" name="format-detection">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link href="./assets/stylesheets/style.css" rel="stylesheet" type="text/css" />
	<script language="javascript" type="text/javascript" src="./assets/javascript/size.js"></script>
	<title>同行大仓</title>
</head>
<body>

	<!-- 页面样式 -->
	<style rel="stylesheet" type="text/css">
		.cm-topline .tl-ctrol{ border-radius: 3px; background: url("./assets/images/ic40_search.png") no-repeat 10px center #F2F2F2; background-size:12px 12px; text-indent: 20px; }
		.tl-screen{ position: absolute; right: 0; top: 0; display: block; height: 44px; width: 44px; padding-top: 26px; background: url("./assets/images/ic40_screen.png") no-repeat center 8px; background-size: 16px 16px; font-size: 10px; color: #666; line-height: 14px; }
		.topfix{ position: fixed; left: 0; top: 0; width: 100%; background: #fff; z-index: 5;}
		.html{ padding: 169px 0 0;}
		.cm-topline-full{ padding: 0 14px; border-bottom: none;}
		.toptabbox{ padding: 0 14px; text-align: center;}
		.tap-tabitem{ display: block; float: left; width: 50%; line-height: 30px; border: 1px solid #eee; border-radius: 0 8px 8px 0; border-left: none; color: #666;}
		.tap-tabitem:nth-child(1){border-left: 1px solid #eee; border-right: none; border-radius: 8px 0 0 8px;}
		.tap-tabitem.active{ background-color: #85DBD8; color: #fff; border-color: #85DBD8;}
		
		.cm-list .gitem-ifbox{ display: block; padding: 0 .1rem;}
		.cm-list .gitem-view{ margin-left: 0; font-size: 12px; color: #999;}
		.cm-list .gitem-bot{ padding-top: 5px;}
		.cm-list .gitem-imgo{ position: relative; padding: 50% 0;}
		.cm-list-cols .gitem-img{ position: absolute; left: 0; top: 0; width: 100%; height: 100%;}

		.gotop{ position: fixed; right: 10px; bottom: 100px; z-index: 5; display: none; height: 40px; width: 40px; background: url(./assets/images/icon_gotop.png) rgba(0,0,0,.3); border-radius: 50%; background-size: 100% 100%;}


	</style>

	<!-- 页面html -->
	<div class="topfix">
		<div class="cm-topline cm-topline-pr" style="top:0;">
			<a href="javascript:;" class="tl-back" id="J_back"></a>
			<p class="tl-title">AE45上海段小狸门面旗舰店</p>
			<a href="javascript:;" class="J_showpop tl-screen" data-target="#J_pop_screen">筛选</a>
		</div>
		<div class="cm-topline cm-topline-full cm-topline-pr">
			<p class="tl-input"><input type="text" placeholder="相关关键词" class="J_blurscroll tl-ctrol" id="J_key" /></p>
		</div>
		<div class="toptabbox">
			<div class="top-tab clearfix">
				<a href="javascript:;" class="J_tab tap-tabitem active" data-type="sell">在售商品</a>
				<a href="javascript:;" class="J_tab tap-tabitem" data-type="done">已成交</a>
			</div>
		</div>
		<div class="cm-sortbox cm-sortbox-thr">
			<!-- data-key 对应排序对象的键值 -->
			<a href="javascript:;" class="J_sort_default sortls" data-type=""><span class="sortls-name">默认排序</span></a>
			<a href="javascript:;" class="J_sort sortls" data-type="price"><span class="sortls-name">价格</span><span class="arw-uds"><span class="arw-ud arw-up"></span><span class="arw-ud arw-down"></span></span></a>
			<a href="javascript:;" class="J_sort sortls" data-type="view"><span class="sortls-name">浏览量</span><span class="arw-uds"><span class="arw-ud arw-up"></span><span class="arw-ud arw-down"></span></span></a>
		</div>
	</div>

	<div class="html pd-b20">
		<div class="cm-list cm-list-cols" id="J_list"></div>

		<!-- 无数据 -->
		<div class="cm-empty" id="J_empty"><img src="../assets/images/empty.png" class="empty-ico" /><p class="empty-tx">暂无数据<a href="javascript:;" id="J_refresh" class="empty-rf">刷新</a></p></div>
		<p class="botmore" id="J_botmore"><img src="assets/images/loading.gif" class="bmimg"><span class="load">正在加载更多···</span><span class="done">数据已全部加载完毕</span></p>
	</div>

	<a href="javascript:;" class="gotop" id="J_gotop"></a>


	<!-- 筛选弹层 -->
	<div class="cm-pop" id="J_pop_screen">
        <a href="javascript:;" class="J_popclose cm-pop-bg" data-target="#J_pop_screen"></a>
        <div class="cm-pop-cont cm-pop-right-cont cm-pop-screen">
            <div class="pop-screenbox">
				<div class="prsitem">
					<p class="prsi_til">品牌<span class="J_screen_show prsi_tr" id="J_name_pinpai"></span></p>
					<p class="prsi_lses" id="J_sls_pinpai">
						<!-- data-key: screen的键值  data-value：键值对应的值 -->
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="1" data-text="CHANEL/香水贵的01">CHANEL/香水贵的01</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="2" data-text="CHANEL/香水贵的02">CHANEL/香水贵的02</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="3" data-text="CHANEL/香水贵的03">CHANEL/香水贵的03</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="4" data-text="CHANEL/香水贵的04">CHANEL/香水贵的04</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="5" data-text="CHANEL/香水贵的05">CHANEL/香水贵的05</a>
					</p>
				</div>
				<div class="prsitem">
					<p class="prsi_til">分类</p>
					<p class="prsi_lses">
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="type" data-value="" data-text="全部">全部</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="type" data-value="2" data-text="单肩包">单肩包</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="type" data-value="3" data-text="双肩包">双肩包</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="type" data-value="4" data-text="链条包">链条包</a>
					</p>
				</div>
				<div class="prsitem">
					<p class="prsi_til">范围</p>
					<p class="prsi_lses">
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="collect" data-value="" data-text="全部">全部</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="collect" data-value="2" data-text="已收藏">已收藏</a>
					</p>
				</div>
			</div>
			<p class="botbtns"><a href="javascript:;" class="bbtn" id="J_sc_reset">重置</a><a href="javascript:;" class="bbtn" id="J_sc_sure">确定</a></p>
        </div>
	</div>

	<script type="text/javascript">
		// app背景颜色设置
		// callapp('bg')
	</script>

	<script language="javascript" type="text/javascript" src="./assets/javascript/jquery-2.1.4.min.js"></script>
	<script language="javascript" type="text/javascript" src="./assets/javascript/tools.js"></script>
	<script type="text/javascript">
		$(function(){
			
			var key = ""; // 预定关键词变量，可根据需求更改结构或名称
			var screen = {}; // 预定义筛选对象，可根据需求更改结构或名称
			var sort = {time:'desc',price:''} //排序
			// 列表加载
			var data = {"page":1,"pagesize":16,type:'sell'},
				locked = false;//设置开关 防止重复提交;


			var J_key = $('#J_key');
            
            J_key.on('blur',function(){
                var v = $(this).val().trim();
				if(v!=key){
					key = v;
					locked = false;
					getajax(true);
				}
                setTimeout(function(){
                    $(window).scrollTop($(window).scrollTop())
                },10)
			})
			
			//tab切换
			$('.J_tab').click(function(){
				var type = $(this).attr('data-type');
				if(type==data.type){ return};
				data.type = type;
				$(this).addClass('active').siblings().removeClass('active')
				getajax(true)
			})

			 // 展开弹层
			 $('.J_showpop').click(function(){
				var tar = $($(this).attr('data-target'));
				tar.addClass('cm-pop-active');
			});
		    //关闭弹层
			$('.J_popclose').click(function(){
				$($(this).attr('data-target')).removeClass('cm-pop-active');
			});
			function closepop(tar){
				tar.removeClass('cm-pop-active');
            };
			function showpop(tar){
				tar.addClass('cm-pop-active');
            };

			//筛选相关js
			var J_pop_screen = $('#J_pop_screen');
			$('.J_kuang').click(function(){
				$(this).addClass('prsi_ls_ac').siblings().removeClass('prsi_ls_ac');
			});

			$('#J_sc_reset').click(function(){
				screen = {}; // 重置screen筛选对象
				$('.J_screen_show').html('')
				$('.prsi_ls_ac').removeClass('prsi_ls_ac');
			});
			$('#J_sc_sure').click(function(){
				// 修改screen的对象值可在页面中对应的位置处理
				alert('筛选后的数据：'+JSON.stringify(screen));
				closepop(J_pop_screen);
				getajax(true);
			});

			$('.J_select').click(function(){
				var self = $(this),
					k = self.attr('data-key'),
					v = self.attr('data-value'),
					t = self.attr('data-text');
				screen[k] = v;
			});

			// 注册下拉滚动效果
			var bm = new botmore(400,function(){
                if(bm.stop) return;
                bm.stop = true;
                
				data.page++;
				getajax();
			});

			//列表相关js
			var J_list = $('#J_list'),
                J_botmore = $('#J_botmore'),
				J_empty = $('#J_empty');

			function getajax(isfirstpage){
				locked = true;

				if(isfirstpage){
					data.page = 1;
					J_botmore.show().attr('class','botmore');
					J_list.html(''); //清空列表
				}
				$.ajax({ 
					type: "GET",
					url: "api/callback.json?v="+(new Date().getTime()),
					data: {},
					dataType: "json",
					success: function(res){
						if(res.code==0){

							//虚拟返回模拟数据
							var nt = new Date();
							res.data = [
								{type:1,collect:true,endtime:nt.getTime()+10000},
								{type:2,collect:true,endtime:nt.getTime()+13*3600000},
								{type:3,endtime:nt.getTime()+1805000},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:1,collect:true,endtime:nt.getTime()+1805000},
								{type:2,collect:true,endtime:nt.getTime()+13*3600000},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true},
								{type:3,soldout:true}
							];

							// 模拟加载完毕
							if(data.page>=3){
								res.data.splice(0,6);
							}
							//模拟少量数据
							// res.data.splice(0,16)


							var str = '',
								len = res.data.length;
							for(var i=0;i<len;i++){
								var v = res.data[i],
									endstr = '';

								if(v.endtime){
									endstr = '<span class="gitem-btime">距结束<span class="J_backtime gitem-bmn" data-endtime="'+v.endtime+'">00:00:00</span></span>';
								}
								var colstr = v.collect?'gitem-collected':'';
								var soldstr = v.soldout?'gitem-imgcover':'';

								str += '<div class="gitem">\
									<a href="detail.html?pid=2" class="gitem-imgbox '+soldstr+'">\
										<p class="gitem-imgo"><img src="./img/img01.png" class="gitem-img"></p>\
										'+endstr+'\
										<span class="gitem-itp">95新</span>\
									</a>\
									<a href="detail.html?pid=2" class="gitem-ifbox">\
										<p class="gitem-title">钱包蔻驰(COACH)牛皮高贵女士皮靴啊牛皮高贵女士皮靴啊</p>\
										<p class=""><span class="gitem-view">454人浏览</span></p>\
										<p class="gitem-bot">\
											<span class="gitem-price">￥1545</span><span class="gitem-cost">/一口价</span>\
										</p>\
									</a>\
									<a href="javascript:;" data-id="2" class="J_collect gitem-collect '+colstr+'"></a>\
								</div>';
							}

							J_list.append(str);

							setTimeout(function(){
								if(len==0&&data.page==1){
									J_empty.show();
									J_botmore.hide();
									bm.stop = true; // 关闭下拉加载
								}else if(len<data.pagesize){// 判断返回数据是否是全部数据
									J_botmore.addClass('botmore-all');
									bm.stop = true; // 关闭下拉加载
									if(J_list.find('.gitem').length<6){
										J_botmore.hide()
									}
								}else{
									bm.stop = false; // 打开下拉加载
								}
								// 初始化倒计时
								backtimeelm();
							},30);
						}else{
							CUES.alert({"msg":"此处可设置提示错误信息"})
						}
					},
					error:function(){
						J_empty.show();
						J_botmore.hide();
						bm.stop = true; // 关闭下拉加载
					}
				})
			}

			// 获取第一屏数据
			getajax(true)

			//收藏
			J_list.on('click','.J_collect',function(){
				var self = $(this),
					id = self.attr('data-id'),
					iscol = (self.hasClass('gitem-collected')?true:false);
				$.ajax({
                    url:'/api/callback.json?t='+(new Date().getTime()),
                    success:function(rs){
                        if(rs.code==0){
							iscol?self.removeClass('gitem-collected'):self.addClass('gitem-collected');
                            CUES.tip({msg:(iscol?'取消成功':'收藏成功')})
                        }
                    }
                })
			})

			function backtimeelm(){
				var J_backtime = $('.J_backtime'),
					len = J_backtime.length;
				for(var i=0;i<len;i++){
					var el = J_backtime.eq(i);
					if(el.attr('data-back')!='1'){
						backtime(el);
						el.attr({'data-back':1});
					}
				}
			}
			function backtime(elm){
				var st = new Date(),
					et = new Date(parseInt(elm.attr('data-endtime')));
				st =st.getTime();
				et = et.getTime();
				var timer = '';
				timer = setInterval(function(){
					if(et-st>1000){
						st+=1000;
						if(et-st<=1800000){ // 30分钟内变红
							elm.parent().addClass('gitem-btime-p');
						}
						elm.html(inittime(Math.floor((et-st)/1000)));
					}else{
						clearInterval(timer);
						elm.html('已结束');
					}
				},1000);
			};
			function inittime(time){
				var h = Math.floor(time/3600),
					m = Math.floor((time%3600)/60);
					s = Math.floor(time%60);
			    return (h<10?'0'+h:h)+':'+(m<10?'0'+m:m)+':'+(s<10?'0'+s:s);
			};

			//排序
			var sortls = $('.sortls');
			//默认
			$('.J_sort_default').click(function(){
				sort = {key:'',type:''}
				$('.sortls-sortdown,.sortls-sortup').removeClass('sortls-sortdown sortls-sortup')
				getajax(true);
			})
			//价格
			$('.J_sort').click(function(){
				var self = $(this),
					key = self.attr('data-type');
				
				if(key!=sort.key){
					$('.sortls-sortdown,.sortls-sortup').removeClass('sortls-sortdown sortls-sortup')
					sort = {key:key,type:''}
				}
				if(sort.type==''){
					self.attr({'class':'J_sort_price sortls sortls-sortdown'});
					sort.type = 'desc';
				}else if(sort.type=='desc'){
					self.attr({'class':'J_sort_price sortls sortls-sortup'});
					sort.type = 'asc';
				}else{
					self.attr({'class':'J_sort_price sortls'});
					sort.type = '';
				};

				getajax(true);
			})

			//刷新
			$('#J_refresh').click(function(){
				getajax(true)
			})

			$(window).scroll(CUES.debounce(function(){
				checktop()
			},200))
			function checktop(){
				if($(window).scrollTop()>300){
					$('#J_gotop').fadeIn(100);
				}else{
					$('#J_gotop').fadeOut(100);
				}
			}
			checktop()
			$('#J_gotop').click(function(){
				$(window).scrollTop(0)
			})
				


		});
	</script>
</body>
</html>
