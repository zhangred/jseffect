<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no">
	<meta content="telephone=no" name="format-detection">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link rel="stylesheet" href="assets/stylesheets/style.css" type="text/css" /> 
	<title>经营看板</title>
</head>
<body>
	<div class="toptilline">
		<p class="til">导出报告</p>
		<a class="tl-back" id="J_back"></a>
	</div>
	<div class="html manage-report" id="J_html">
		<div class="editlinebox editlinebox-nmt">
			<form id="J_form">
				<div class="J_choosetime editline editline-cover editline-select" data-key="start" data-timegroup="y-m-d" data-format="y-m-d" id="J_time_start">
					<p class="el-ado">起始日期</p>
					<p class="el-input"><input type="text" name="" placeholder="请选择" class="el-ctrol"></p>
				</div>

				<div class="J_choosetime editline editline-cover editline-select"data-key="end" data-timegroup="y-m-d" data-format="y-m-d" id="J_time_end">
					<p class="el-ado">结束日期</p>
					<p class="el-input"><input type="text" name="" placeholder="请选择" class="el-ctrol"></p>
				</div>
				<div class="editline">
					<p class="el-ado">接收邮箱</p>
					<p class="el-input"><input type="text" name="" placeholder="请输入接收报告的电子邮箱" id="J_email" class=" el-ctrol"></p>
				</div>

			</form>
		</div>
		<p class="tip">注：明细将在系统导出后发送至您的邮箱。请确认邮箱填写无误,否则将影响报告的发送。</p>

		<p class="botbtn"><a href="javascript:;" class="btn" id="J_btn">导出</a></p>
	</div>


	<script language="javascript" type="text/javascript" src="assets/javascript/jquery-2.1.4.min.js"></script>
	<script language="javascript" type="text/javascript" src="assets/javascript/func.js"></script>
	<script type="text/javascript">
		$(function(){
			// 获取当月天数
			function getdays(date){
				var m = date.getMonth();
				date.setMonth(m + 1);
				date.setDate(0);
				return date.getDate();
			};

			// 预定义提交数据
			var data = {},
				locked = false;//设置开关 防止重复提交;

			var active_time = new Date();

			data.timestart = CUES.timeformat(active_time,'y-m-01');
			data.timeend = CUES.timeformat(active_time,'y-m-'+getdays(active_time));

			var J_time_start = $('#J_time_start'),
				J_time_end = $('#J_time_end');
			
			J_time_start.attr('data-time',data.timestart).find('input').val(data.timestart);
			J_time_end.attr('data-time',data.timeend).find('input').val(data.timeend);

			//初始化时间选择器
			var dt = new dateselect({
				"targets":document.getElementsByClassName('J_choosetime'),
				"selected":function(opt){
					var timetype = $(opt.target).attr('data-key');
					if(timetype=='start'){
						var tend = new Date(data.timeend.replace(/\-/ig,'/')).getTime();
						var tsta = new Date(opt.time.getTime());
						if(tsta>tend){
							CUES.tip({"msg":"起始日期不可大于结束日期"})
						}else{
							data.timestart = opt.timestr;
							J_time_start.find('input').val(opt.timestr);
							dt.hide();
						}
					}else if(timetype=='end'){
						var tsta = new Date(data.timestart.replace(/\-/ig,'/')).getTime();
						var tend = new Date(opt.time.getTime());
						if(tsta>tend){
							CUES.tip({"msg":"结束日期不可小于起始日期"})
						}else{
							data.timeend = opt.timestr;
							J_time_end.find('input').val(opt.timestr);
							dt.hide();
						}
					}
				}
			});

			var J_save = $('#J_btn');
		   	J_save.click(function(){

		   		var emial = $('#J_email').val().trim();
		   		if(!emial){
		   			CUES.tip({"msg":"请输入邮箱"})
		   			return;
				};
				data.emial = emial;
		   		
				locked = true;
				console.log(data)
		   		J_save.html('正在提交···');
		   		//保存提交数据
				$.ajax({ 
					type: "GET",
					url: "api/callback.json?v="+(new Date().getTime()),
					data: {},
					dataType: "json",
					success: function(res){
						if(res.code==0){
							localStorage.pass_email = data.emial;
							window.location.href = 'manage_report_status.html'
						}
					},
					complete:function(){
						locked = false;
						J_save.html('提交');
					}
				});

		   	});

		});
	</script>
</body>
</html>
