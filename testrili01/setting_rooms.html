<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no">
	<meta content="telephone=no" name="format-detection">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link rel="stylesheet" href="assets/stylesheets/style.css" type="text/css" /> 
	<title>房间管理</title>
</head>
<body>
	<div class="toptilline">
		<p class="til">房间管理</p>
		<a class="tl-back" id="J_back"></a>
	</div>
	<div class="html settingrooms" id="J_html">
		<div class="editlinebox editlinebox-nmt" id="J_list">
			<!-- <a href="javascript:;" class="editline editline-cover editline-select">
				<p class="el-ado">龙阳101</p>
				<p class="el-text el-text-ash"></p>
			</a> -->
		</div>
		<p class="botmore" id="J_botmore"><img src="assets/images/loading.gif" class="bmimg"><span class="load">正在加载更多···</span><span class="done">数据已全部加载完毕</span></p>
	</div>
	<div class="botbtnline">
		<a href="javascript:;" class="btn" id="J_addroom"><img src="assets/images/icon_plus.png" class="icoa">新建房间</a>
	</div>

	<!-- 新建编辑弹层 -->
	<div class="pop" id="J_pop_room">
		<div class="pop-cont pop-mid-cont pop-room">
			<a href="javascript:;" data-target="#J_pop_room" class="J_togglepop close"></a>
			<p class="pop-cont-til" id="J_pop_til">新建客房</p>
			<div class="editlinebox editlinebox-nmt" id="J_list">
				<div class="editline">
					<p class="el-ado">房间名称</p>
					<p class="el-input"><input type="text" name="" placeholder="请填写" class="el-ctrol" id="J_pop_name"></p>
				</div>
				<div class="editline editline-cover editline-select" id="J_line_from">
					<p class="el-ado">默认渠道</p>
					<p class="el-input"><input type="text" name="" placeholder="请选择" class="el-ctrol" id="J_pop_from"></p>
				</div>
				<div class="editline">
					<p class="el-ado">是否启用</p>
					<p class="el-text clearfix"><span id="J_switch" class="J_el_switch el-switch el-switch-active"></span></p>
				</div>
				<span></span>
			</div>
			<div class="bot"><a class="J_rooms cmbtn" href="javascript:;" id="J_save">保存</a></div>
		</div>
	</div>


	<script language="javascript" type="text/javascript" src="assets/javascript/jquery-2.1.4.min.js"></script>
	<script language="javascript" type="text/javascript" src="assets/javascript/func.js"></script>
	<script type="text/javascript">
		$(function(){
			// 列表加载
			var pagedata = {"page":0,"pagesize":30},
				locked = false;//设置开关 防止重复提交;

			var J_list = $('#J_list'),
				J_botmore = $('#J_botmore');

			// 注册下拉滚动效果
			var bm = new botmore(240,function(){
				pagedata.page++;
				getajax();
			});

			//弹层切换
			$('.J_togglepop').on('click',function(){
				$($(this).attr('data-target')).toggleClass('pop_active')
			});

			function getajax(first){
				if(first){
					pagedata.page = 1;
					J_botmore.attr('class','botmore');
					J_list.html(''); //清空列表
				};
				// ajax获取列表数据
				locked = true;
				bm.stop = true; // 关闭下拉加载
				console.log(5,pagedata)
				$.ajax({ 
					type: "GET",
					url: "api/callback.json?v="+(new Date().getTime()),
					data: {},
					dataType: "json",
					success: function(res){
						locked =false;
						if(res.code==0){
							
							//虚拟返回模拟数据
							res.data = [
								{"id":1,"name":"龙阳101","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":2,"name":"龙阳102","from":{"id":5,"name":"途牛网"}},
								{"id":3,"name":"龙阳103","from":{"id":5,"name":"途牛网"}},
								{"id":4,"name":"龙阳104","from":{"id":5,"name":"途牛网"}},
								{"id":5,"name":"龙阳105","from":{"id":5,"name":"途牛网"}},
								{"id":6,"name":"龙阳106","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":7,"name":"龙阳107","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":8,"name":"龙阳108","from":{"id":5,"name":"途牛网"}},
								{"id":9,"name":"龙阳109","from":{"id":5,"name":"途牛网"}},
								{"id":10,"name":"龙阳110","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":1,"name":"龙阳101","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":2,"name":"龙阳102","from":{"id":5,"name":"途牛网"}},
								{"id":3,"name":"龙阳103","from":{"id":5,"name":"途牛网"}},
								{"id":4,"name":"龙阳104","from":{"id":5,"name":"途牛网"}},
								{"id":5,"name":"龙阳105","from":{"id":5,"name":"途牛网"}},
								{"id":6,"name":"龙阳106","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":7,"name":"龙阳107","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":8,"name":"龙阳108","from":{"id":5,"name":"途牛网"}},
								{"id":9,"name":"龙阳109","from":{"id":5,"name":"途牛网"}},
								{"id":10,"name":"龙阳110","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":1,"name":"龙阳101","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":2,"name":"龙阳102","from":{"id":5,"name":"途牛网"}},
								{"id":3,"name":"龙阳103","from":{"id":5,"name":"途牛网"}},
								{"id":4,"name":"龙阳104","from":{"id":5,"name":"途牛网"}},
								{"id":5,"name":"龙阳105","from":{"id":5,"name":"途牛网"}},
								{"id":6,"name":"龙阳106","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":7,"name":"龙阳107","from":{"id":5,"name":"途牛网"},"forbid":true},
								{"id":8,"name":"龙阳108","from":{"id":5,"name":"途牛网"}},
								{"id":9,"name":"龙阳109","from":{"id":5,"name":"途牛网"}},
								{"id":10,"name":"龙阳110","from":{"id":5,"name":"途牛网"},"forbid":true}
							];
							
							var dt = res.data,len = dt.length,str = '';
							for(var i=0;i<len;i++){
								var v = dt[i],
									fbd = v.forbid?'<p class="el-text el-text-ash">禁用</p>':'';

								str += '<a href="javascript:;" data-id="'+v.id+'" data-name="'+v.name+'" data-fromid="'+v.from.id+'" data-fromname="'+v.from.name+'" data-forbid="'+(v.forbid?'1':'')+'" class="J_rooms editline editline-cover editline-select">\
									<p class="el-ado">'+v.name+'</p>'+fbd+'\
								</a>';
							};
							J_list.append(str);
							setTimeout(function(){
								bm.stop = false; // 打开下拉加载
								if(len<data.pagesize){// 判断返回数据是否是全部数据
									J_botmore.attr('class','botmore botmore-all');
									bm.stop = true; // 关闭下拉加载
								};
							},30);
							//----------end--------
						}else{
							CUES.alert({"msg":"此处可设置提示错误信息"})
						};
					}
				});
			};

			// 获取第一屏房间明细数据
			getajax(true);

			var data = {}; //预定义提交对象

			J_list.on('click','.J_rooms',function(){
				var self = $(this);
				data.id = parseInt(self.attr('data-id'))||'';
				data.name = self.attr('data-name')||'';
				data.from = {"id":parseInt(self.attr('data-fromid')),"name":self.attr('data-fromname')};
				data.forbid = self.attr('data-forbid')?true:false;
				stfrom.init({"default_v":data.from.id})
				setpopdom();
			})
			$('#J_addroom').click(function(){
				data = {"from":{},"forbid":true};
				setpopdom();
			})
			
			var J_pop_til = $('#J_pop_til'),
				J_pop_name = $('#J_pop_name'),
				J_pop_from = $('#J_pop_from'),
				J_switch = $('#J_switch');
			
			J_switch.click(function(){
				if(J_switch.hasClass('el-switch-active')){
					J_switch.removeClass('el-switch-active');
					data.forbid = false;
				}else{
					J_switch.addClass('el-switch-active');
					data.forbid = true;
				}
			});
			// 初始化弹层
			function setpopdom(){
				J_pop_til.html(data.id?'编辑房间':'新增房间');
				J_pop_name.val(data.name||'');
				J_pop_from.val(data.from.name||'');
				data.forbid?J_switch.addClass('el-switch-active'):J_switch.removeClass('el-switch-active');
				$('#J_pop_room').addClass('pop_active');
			};

			//来源选择
		    var fromarr = [ 
		    	{"id":5,"name":"途牛"},
    			{"id":6,"name":"携程"},
    			{"id":7,"name":"艺龙"},
    			{"id":8,"name":"去哪儿"},
    			{"id":97,"name":"同城"}
		    ];
		    var stfrom = new dataSelect({
		        "target":document.getElementById('J_line_from'), // 目标对象dom
		        "fieldshow":"name",// 必选 显示字段
		        "fieldvalue":"id",// 必选 值匹配字段
		        "default_v":0, // 设置默认值
		        "data":fromarr, // 选项数据
		        "selected":function(v){
		        	if(v&&v.id){
		        		J_pop_from.val(v.name);
		        		stfrom.hide();
		        	}else{
		        		CUES.tip({"msg":"请选择"})
		        	}
		        }
		    });
			

			//保存
			var J_save = $('#J_save');
		   	J_save.click(function(){
		   		if(locked){ return;}

		   		var name = J_pop_name.val().trim();
		   		if(!name){
		   			CUES.tip({"msg":"请填写房间名称"})
		   			return;
				   };
				   
		   		var from = J_pop_from.val().trim();
		   		if(!from){
		   			CUES.tip({"msg":"请选择渠道"})
		   			return;
		   		};

				data.name = name;
				data.from = stfrom.v;
				data.forbid = J_switch.hasClass('el-switch-active')?true:false;
		   		
		   		locked = true;

				J_save.html('正在提交···');
				console.log(data)
		   		//保存提交数据
				$.ajax({ 
					type: "GET",
					url: "api/callback.json?v="+(new Date().getTime()),
					data: {},
					dataType: "json",
					success: function(res){
						if(res.code==0){
							CUES.tip({"msg":"提交成功","callback":function(){
								window.location.href = window.location.href;
							}})
						}
					},
					complete:function(){
						locked = false;
						J_save.html('提交');
					}
				});

			});


		});
	</script>
</body>
</html>
