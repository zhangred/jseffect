<!DOCTYPE>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no">
	<meta content="telephone=no" name="format-detection">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link href="./assets/stylesheets/style.css" rel="stylesheet" type="text/css" />
	<script language="javascript" type="text/javascript" src="./assets/javascript/size.js"></script>
	<title>同行大仓</title>
</head>
<body>

	<!-- 页面样式 -->
	<style rel="stylesheet" type="text/css">
		.cm-topline .tl-ctrol{ border-radius: 3px; background: url("./assets/images/ic40_search.png") no-repeat 10px center #F2F2F2; background-size:12px 12px; text-indent: 20px; }
		.tl-screen{ position: absolute; right: 0; top: 0; display: block; height: 44px; width: 44px; padding-top: 26px; background: url("./assets/images/ic40_screen.png") no-repeat center 8px; background-size: 16px 16px; font-size: 10px; color: #666; line-height: 14px; }
		.topfix{ position: fixed; left: 0; top: 0; width: 100%; background: #fff; z-index: 5;}
		.html{ padding: 92px 0 50px;}
		
		.cm-list .gitem-itp{ background: rgba(0,0,0,.7)}
		.cm-list .gitem-top{ height: .64rem;}
		.bot{ position: fixed; left: 0; bottom: 0; right: 0; z-index: 3; background: #fff; overflow: hidden; text-align: center; font-size: .16rem; line-height: 50px;}
		.bls{ display: block; width: 50%; float: left;}
		.bico{ height: 15px; margin-right: 6px; vertical-align: middle; position: relative; top: -1px;}
		.blsa{ background: #85DBD8; color: #fff;}
	</style>

	<!-- 页面html -->
	<div class="topfix">
		<div class="cm-topline cm-topline-pr" style="top:0;">
			<a href="javascript:;" class="tl-back" id="J_back"></a>
			<p class="tl-inbox"><input type="text" class="tl-ctrol" name="" id="J_key" placeholder="店铺名称、商品关键词、品牌"></p>
			<a href="javascript:;" class="J_showpop tl-screen" data-target="#J_pop_screen">筛选</a>
		</div>
		<div class="cm-tabbox cm-tabbox3">
			<a href="" class="J_cmtab cmtab cmtab-active"><p class="cmtab-in">同行大仓</p></a>
			<a href="" class="J_cmtab cmtab"><p class="cmtab-in">关注店铺</p></a>
			<a href="" class="J_cmtab cmtab"><p class="cmtab-in">我的收藏</p></a>
		</div>
	</div>

	<div class="html pd-b80">
		<div class="cm-list cm-list-cols" id="J_list"></div>

		<!-- 无数据 -->
		<div class="cm-empty" id="J_empty"><img src="../assets/images/empty.png" class="empty-ico" /><p class="empty-tx">暂无数据</p></div>

		<p class="botmore" id="J_botmore"><img src="assets/images/loading.gif" class="bmimg"><span class="load">正在加载更多···</span><span class="done">数据已全部加载完毕</span></p>
	</div>

	<!-- 底部按钮 -->
	<div class="bot">
		<a href="" class="bls pd-b20"><img class="bico" src="./assets/images/icon49_mine.png" />我的</a>
		<a href="./49share.html" class="bls blsa pd-b20"><img class="bico" src="./assets/images/icon49_share.png" />分享我的大仓</a>
	</div>

	<!-- 筛选弹层 -->
	<div class="cm-pop" id="J_pop_screen">
        <a href="javascript:;" class="J_popclose cm-pop-bg" data-target="#J_pop_screen"></a>
        <div class="cm-pop-cont cm-pop-right-cont cm-pop-screen">
            <div class="pop-screenbox">
				<div class="prsitem">
					<p class="prsi_til">品牌<span class="J_screen_show prsi_tr" id="J_name_pinpai"></span></p>
					<p class="prsi_lses" id="J_sls_pinpai">
						<!-- data-key: screen的键值  data-value：键值对应的值 -->
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="1" data-text="CHANEL/香水贵的01">CHANEL/香水贵的01</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="2" data-text="CHANEL/香水贵的02">CHANEL/香水贵的02</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="3" data-text="CHANEL/香水贵的03">CHANEL/香水贵的03</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="4" data-text="CHANEL/香水贵的04">CHANEL/香水贵的04</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="pinpai" data-value="5" data-text="CHANEL/香水贵的05">CHANEL/香水贵的05</a>
					</p>
				</div>
				<div class="prsitem">
					<p class="prsi_til">分类</p>
					<p class="prsi_lses">
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="type" data-value="" data-text="全部">全部</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="type" data-value="2" data-text="单肩包">单肩包</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="type" data-value="3" data-text="双肩包">双肩包</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="type" data-value="4" data-text="链条包">链条包</a>
					</p>
				</div>
				<div class="prsitem">
					<p class="prsi_til">范围</p>
					<p class="prsi_lses">
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="collect" data-value="" data-text="全部">全部</a>
						<a href="javascript:;" class="J_select J_kuang prsi_ls" data-key="collect" data-value="2" data-text="已收藏">已收藏</a>
					</p>
				</div>
			</div>
			<p class="botbtns"><a href="javascript:;" class="bbtn" id="J_sc_reset">重置</a><a href="javascript:;" class="bbtn" id="J_sc_sure">确定</a></p>
        </div>
	</div>

	<script type="text/javascript">
		// app背景颜色设置
		// callapp('bg')
	</script>

	<script language="javascript" type="text/javascript" src="./assets/javascript/jquery-2.1.4.min.js"></script>
	<script language="javascript" type="text/javascript" src="./assets/javascript/tools.js"></script>
	<script type="text/javascript">
		$(function(){
			
			var key = ""; // 预定关键词变量，可根据需求更改结构或名称
			var screen = {}; // 预定义筛选对象，可根据需求更改结构或名称
			// 列表加载
			var data = {"page":1,"pagesize":16},
				locked = false;//设置开关 防止重复提交;


			var J_tl = $('#J_tl'),
                J_key = $('#J_key');
            
            J_key.on('blur',function(){
                var v = $(this).val().trim();
				if(v!=key){
					key = v;
					locked = false;
					getajax(true);
				}
                setTimeout(function(){
                    $(window).scrollTop($(window).scrollTop())
                },10)
            })

			 // 展开弹层
			 $('.J_showpop').click(function(){
				var tar = $($(this).attr('data-target'));
				tar.addClass('cm-pop-active');
			});
		    //关闭弹层
			$('.J_popclose').click(function(){
				$($(this).attr('data-target')).removeClass('cm-pop-active');
			});
			function closepop(tar){
				tar.removeClass('cm-pop-active');
            };
			function showpop(tar){
				tar.addClass('cm-pop-active');
            };

			//筛选相关js
			var J_pop_screen = $('#J_pop_screen');
			$('.J_kuang').click(function(){
				$(this).addClass('prsi_ls_ac').siblings().removeClass('prsi_ls_ac');
			});

			$('#J_sc_reset').click(function(){
				screen = {}; // 重置screen筛选对象
				$('.J_screen_show').html('')
				$('.prsi_ls_ac').removeClass('prsi_ls_ac');
			});
			$('#J_sc_sure').click(function(){
				// 修改screen的对象值可在页面中对应的位置处理
				alert('筛选后的数据：'+JSON.stringify(screen));
				closepop(J_pop_screen);
				getajax(true);
			});

			$('.J_select').click(function(){
				var self = $(this),
					k = self.attr('data-key'),
					v = self.attr('data-value'),
					t = self.attr('data-text');
				screen[k] = v;
			});

			// 注册下拉滚动效果
			var bm = new botmore(400,function(){
                if(bm.stop) return;
                bm.stop = true;
                
				data.page++;
				getajax();
			});

			//列表相关js
			var J_list = $('#J_list'),
                J_botmore = $('#J_botmore'),
				J_empty = $('#J_empty');

			function getajax(isfirstpage){
				locked = true;

				if(isfirstpage){
					data.page = 1;
					J_botmore.show().attr('class','botmore');
					J_list.html(''); //清空列表
				}
				$.ajax({ 
					type: "GET",
					url: "api/callback.json?v="+(new Date().getTime()),
					data: {},
					dataType: "json",
					success: function(res){
						if(res.code==0){

							//虚拟返回模拟数据
							var nt = new Date();
							res.data = [
								{id:1,type:1,collect:true},
								{id:2,type:2,collect:true,guanzhu:true},
								{id:3,type:2},
								{id:3,type:1,guanzhu:true},
								{id:3,type:1},
								{id:3,type:1},
								{id:3,type:1},
								{id:3,type:1,guanzhu:true},
								{id:3,type:1},
								{id:3,type:1},
								{id:3,type:1},
								{id:3,type:1,guanzhu:true},
								{id:3,type:1},
								{id:3,type:1},
								{id:3,type:1,guanzhu:true},
								{id:3,type:1}
							];


							var str = '',
								len = res.data.length;
							for(var i=0;i<len;i++){
								var v = res.data[i],
									endstr = '';

								if(v.endtime){
									endstr = '<span class="gitem-btime">距结束<span class="J_backtime gitem-bmn" data-endtime="'+v.endtime+'">00:00:00</span></span>';
								}
								var colstr = v.collect?'gitem-collected':'';
								var gzstr = v.guanzhu?'active':'';

								str += '<div class="gitem">\
									<a href="detail.html?pid=2" class="gitem-imgbox">\
										<img src="./img/img01.png" class="gitem-img">\
										<span class="gitem-itp">'+backtype(v.type)+'</span>\
									</a>\
									<div class="gitem-info">\
										<div class="gitem-top">\
											<a href="detail.html?pid=2" class="gitem-title">钱包蔻驰(COACH)牛皮高贵女士皮靴啊牛皮高贵女士皮靴啊</a>\
											<p class="gitem-desc">苏州名品<a href="javascript:;" class="J_guanzhu gitem-gz '+gzstr+'" data-id="1">'+(v.guanzhu?'已关注':'<img src="./assets/images/icon49_gz.png" class="gitem-gzio"/>关注')+'</a></p>\
										</div>\
										<p class="gitem-bot">\
											<span class="gitem-price">￥1545</span><span class="gitem-cost">/同行价</span>\
										</p>\
										<a href="javascript:;" data-id="2" class="J_collect gitem-collect '+colstr+'"></a>\
									</div>\
								</div>';
							}

							J_list.append(str);

							setTimeout(function(){
								if(len==0&&data.page==1){
									J_empty.show();
									J_botmore.hide();
									bm.stop = true; // 关闭下拉加载
								}else if(len<data.pagesize){// 判断返回数据是否是全部数据
									J_botmore.addClass('botmore-all');
									bm.stop = true; // 关闭下拉加载
								}else{
									bm.stop = false; // 打开下拉加载
								}
								// 初始化倒计时
								backtimeelm();
							},30);
						}else{
							CUES.alert({"msg":"此处可设置提示错误信息"})
						}
					}
				})
			}

			// 获取第一屏数据
			getajax(true)

			//返回商品类型
			function backtype(v){
				if(v==1){
					return '二手'
				}else if(v==2){
					return '全新'
				}else if(v==3){
					return '二手闲置'
				}else{
					return '其他'
				}
			}

			//收藏
			J_list.on('click','.J_collect',function(){
				var self = $(this),
					id = self.attr('data-id'),
					iscol = (self.hasClass('gitem-collected')?true:false);
				$.ajax({
                    url:'/api/callback.json?t='+(new Date().getTime()),
                    success:function(rs){
                        if(rs.code==0){
							iscol?self.removeClass('gitem-collected'):self.addClass('gitem-collected');
                            CUES.tip({msg:(iscol?'取消成功':'收藏成功')})
                        }
                    }
                })
			})
			//关注
			
			J_list.on('click','.J_guanzhu',function(){
				var self = $(this),
					id = self.attr('data-id');
				
				if(self.hasClass('active')){ return}
				$.ajax({
                    url:'/api/callback.json?t='+(new Date().getTime()),
                    success:function(rs){
                        if(rs.code==0){
							self.addClass('active').html('已关注');
                            CUES.tip({msg:'关注成功'})
                        }
                    }
                })
			})

			function backtimeelm(){
				var J_backtime = $('.J_backtime'),
					len = J_backtime.length;
				for(var i=0;i<len;i++){
					var el = J_backtime.eq(i);
					if(el.attr('data-back')!='1'){
						backtime(el);
						el.attr({'data-back':1});
					}
				}
			}
		});
	</script>
</body>
</html>
