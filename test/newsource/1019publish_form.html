<!DOCTYPE>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1.0, maximum-scale=1.0, width=device-width">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta content="black" name="apple-mobile-web-app-status-bar-style">
	<meta name="format-detection" content="telephone=no">
	<meta content="telephone=no" name="format-detection">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link href="./assets/css/style.css" rel="stylesheet" type="text/css" />
	<script language="javascript" type="text/javascript" src="./assets/js/size.js"></script>
	<title>发布文章-营销通</title>
</head>
<body>
	<style>
		.html{ padding-bottom: .8rem;}
		.topinfo{ min-height: 1.28rem; padding: .14rem .1rem .14rem 1.28rem; background-color: #fff; border-bottom: 1px solid #eee; line-height: .2rem;}
		.ti-img{ position: absolute; left: .14rem; top: .14rem; width: 1rem; height: 1rem;}
		.ti-title{ font-size: .16rem; font-weight: bold;}
		.ti-desc{ color: #666; margin-top: .1rem;}
		.ti-tool{ padding-top: .14rem; padding-right: .1rem; text-align: right;}
		.ti-do{  display: inline-block; margin-left: .3rem;}
		.ti-do .iconfont{ margin-right: .04rem;}
		.cm-til{ position: relative; padding: .05rem 0; line-height: .4rem; font-size: .16rem; font-weight: bold; border-bottom: 1px solid #eee;}
		.cm-til::before{ content: ""; position: absolute; left: -.14rem; top: .17rem; display: block; width: .04rem; height: .16rem; background-color: #18AEF7;}
		.ellipsis2{overflow:hidden; text-overflow:ellipsis;display:-webkit-box; -webkit-box-orient:vertical;-webkit-line-clamp:2;}
		.cp-top{ position: absolute; left: 0; top: 0; right: 0; z-index: 3; background-color: #fff;}
		.cp-top-search{ position: relative; padding: .1rem .64rem .1rem .14rem;}
		.cp-top-input{ display: block; border: .01rem solid #eee; border-radius: .04rem; height: .4rem; width: 100%; padding-left: .14rem;}
		.cp-top-close{ position: absolute; right: 0; top: .1rem; width: .6rem; text-align: center; line-height: .4rem;}
		.cp-top-tab{ height: .4rem; text-align: center; background-color: #f3f3f3; border-top: 1px solid #f3f3f3;}
		.cp-top-point{ display: block; float: left; width: 50%; height: .4rem; line-height: .4rem; color: #999;}
		.cp-top-point.active{ color: #222; background-color: #fff;}
		.cp-bot{ position: absolute; left: 0; bottom: 0; right: 0; top: 0;  overflow-y: scroll; padding: 1.01rem 0 .2rem .14rem; line-height: .44rem;}
		.ct-citem{ position: relative; display: block; border-bottom: 1px solid #f3f3f3;}
		.ct-do{ position: absolute; right: 0; top: 0; padding: 0 .14rem;}
		.ct-do.disabled{ color: #999;}
		.ct-cont{ display: none;}
		.ct-emp{ padding: .2rem 0; text-align: center; color: #999;}
		.ct-do .icon-del01{ margin-right: .04rem;}
		.ct-citem{ position: relative; padding: .1rem .8rem .1rem 0; line-height: .2rem;}
		.bra-item-dc{ padding-top: .08rem; color: #999;}
		.ct-citem .ct-do{ top: .1rem;}
		.ct-citem .ct-inc{ position: absolute; right: .8rem; top: .1rem;}
		.ct-citem .icon-check05h{ display: none; color: #18AEF7;}
		.ct-citem .icon-check05{color: #999;}
		.checked .icon-check05h{ display: inline;}
		.checked .icon-check05{ display: none;}
		.redcou{position: absolute; left: 0; bottom: 0; right: 0; top: 0;  overflow-y: scroll;padding: .6rem 0 .5rem;}
		.rc-list{ padding-left: .14rem;}
		.rc-item{ position: relative; display: block; padding-right: .44rem; line-height: .48rem; border-bottom: 1px solid #eee;}
		.rc-tip{ float: right;color: #999;}
		.rc-item.active{ color: #18AEF7;}
		.rc-item .iconfont{ position: absolute; right: .14rem; top: 0; display: none;}
		.rc-item.active .iconfont{ display: block;}

	</style>
	<div class="html">
		<div class="topinfo">
			<img src="./img/img01.png" class="ti-img" />
			<div class="ti-title ellipsis2">小米 Air2 Pro 体验：买吧，这应该就是千元内最强的降噪真无线耳机小米 Air2 Pro 体验：买吧，这应该就是千元内最强的降噪真无线耳机</div>
			<div class="ti-desc ellipsis2">求品质再上一层楼的至尊纪念版好不好？求品质再上一层楼的至尊纪念版好不好？求品质再上一层楼的至尊纪念版好不好？</div>
			<p class="ti-tool">
				<a href="" class="ti-do"><i class="iconfont icon-see"></i>查看</a>
				<a href="" class="ti-do"><i class="iconfont icon-edit"></i>编辑</a>
			</p>
		</div>

		<div class="cm-editlines">
			<p class="cm-til gb-before-bgc">发送对象</p>
			<a href="javascript:;" class="J_togglepop eline eline-select eline-cover" data-target="#J_pop_staff">
				<p class="elado">员工</p>
				<p class="el-input"><input type="text" placeholder="未设置" class="el-ctrol" id="J_ctrol_staff"></p>
			</a>
			<a href="javascript:;" class="J_togglepop eline eline-select eline-cover" data-target="#J_pop_branch">
				<p class="elado">部门</p>
				<p class="el-input"><input type="text" placeholder="未设置" class="el-ctrol" id="J_ctrol_branch"></p>
			</a>
			<a href="javascript:;" class="J_togglepop eline eline-select eline-cover" data-target="#J_pop_custom">
				<p class="elado">自定义组织</p>
				<p class="el-input"><input type="text" placeholder="未设置" class="el-ctrol" id="J_ctrol_custom"></p>
			</a>
		</div>
		<div class="cm-editlines">
			<p class="cm-til gb-before-bgc">福利设置</p>
			<a href="javascript:;" class="J_togglepop eline eline-select eline-cover" data-target="#J_pop_redpack" data-type="redpack">
				<p class="elado">裂变红包</p>
				<p class="el-input"><input type="text" placeholder="未设置" class="el-ctrol" id="J_ctrol_redpack"></p>
			</a>
			<a href="javascript:;" class="J_togglepop eline eline-select eline-cover" data-target="#J_pop_coupon" data-type="coupon">
				<p class="elado">活动券</p>
				<p class="el-input"><input type="text" placeholder="未设置" class="el-ctrol" id="J_ctrol_coupon"></p>
			</a>
			<a href="javascript:;" class="eline">
				<p class="elado">阅读积分奖励/每人</p>
				<p class="el-input"><input type="number" placeholder="未设置" value="0" id="J_reward" class="J_blurscroll el-ctrol"></p>
			</a>
		</div>
		<div class="cm-editlines">
			<p class="cm-til gb-before-bgc">其他设置</p>
			<a href="javascript:;" class="eline">
				<p class="elado">文章允许评论</p>
				<div class="el-text ovh"><span data-key="iscomment" class="J_switch cm-switch"></span></div>
			</a>
			<a href="javascript:;" class="eline">
				<p class="elado">文章底部显示个人信息栏</p>
				<div class="el-text ovh"><span data-key="isbotbar" class="J_switch cm-switch"></span></div>
			</a>
			<a href="javascript:;" class="eline">
				<p class="elado">显示合伙人注册入口</p>
				<div class="el-text ovh"><span data-key="isenter" class="J_switch cm-switch"></span></div>
			</a>
			<a href="javascript:;" class="eline">
				<p class="elado">企业内容人员阅读可获得积分</p>
				<div class="el-text ovh"><span data-key="isreward" class="J_switch cm-switch"></span></div>
			</a>
		</div>

		<a href="javascript:;" class="cm-blbtn gb-bgc" id="J_save">发布</a>
	</div>

	<!-- 员工弹层 -->
	<div class="cm-pop" id="J_pop_staff">
		<a href="javascript:;" class="J_togglepop cm-pop-bg" data-target="#J_pop_staff"></a>
		<div class="J_tabbox cm-pop-cont cm-pop-full-cont pop-custom">
			<div class="cp-top">
				<div class="cp-top-search">
					<input type="text" placeholder="请输入输入员工名称快速添加" class="J_blurscroll cp-top-input" id="J_yuangong_input" />
					<a href="javascript:;" class="J_togglepop cp-top-close" data-target="#J_pop_staff">关闭</a>
				</div>
				<div class="cp-top-tab">
					<a href="javascript:;" data-index="0" class="J_tab_point cp-top-point active">已选员工（<span id="J_staff_num">0</span>）</a>
					<a href="javascript:;" data-index="1" class="J_tab_point cp-top-point">搜索结果</a>
				</div>
			</div>
			<div class="cp-bot touchsc">
				<div class="J_tab_cont ct-cont ct-chooses" style="display: block;" id="J_choose_staff"><p class="ct-emp">暂无选择信息</p></div>
				<div class="J_tab_cont ct-cont ct-search" id="J_search_staff"><p class="ct-emp">暂无搜索信息</p></div>
			</div>
		</div>
	</div>

	<!-- 部门弹层 -->
	<div class="cm-pop" id="J_pop_branch">
		<a href="javascript:;" class="J_togglepop cm-pop-bg" data-target="#J_pop_branch"></a>
		<div class="J_tabbox cm-pop-cont cm-pop-full-cont pop-custom">
			<div class="cp-top">
				<div class="cp-top-search">
					<input type="text" placeholder="输入部门名称快速添加" class="J_blurscroll cp-top-input" id="J_branch_input" />
					<a href="javascript:;" class="J_togglepop cp-top-close" data-target="#J_pop_branch">关闭</a>
				</div>
				<div class="cp-top-tab">
					<a href="javascript:;" data-index="0" class="J_tab_point cp-top-point active">已选部门（<span id="J_branch_num">0</span>）</a>
					<a href="javascript:;" data-index="1" class="J_tab_point cp-top-point">搜索结果</a>
				</div>
			</div>
			<div class="cp-bot touchsc">
				<div class="J_tab_cont ct-cont ct-chooses" style="display: block;" id="J_choose_branch"><p class="ct-emp">暂无选择信息</p></div>
				<div class="J_tab_cont ct-cont ct-search" id="J_search_branch"><p class="ct-emp">暂无搜索信息</p></div>
			</div>
		</div>
	</div>

	<!-- 自定义组织弹层 -->
	<div class="cm-pop" id="J_pop_custom">
		<a href="javascript:;" class="J_togglepop cm-pop-bg" data-target="#J_pop_custom"></a>
		<div class="J_tabbox cm-pop-cont cm-pop-full-cont pop-custom">
			<div class="cp-top">
				<div class="cp-top-search">
					<input type="text" placeholder="输入组织名称快速添加" class="J_blurscroll cp-top-input" id="J_custom_input" />
					<a href="javascript:;" class="J_togglepop cp-top-close" data-target="#J_pop_custom">关闭</a>
				</div>
				<div class="cp-top-tab">
					<a href="javascript:;" data-index="0" class="J_tab_point cp-top-point active">已选部门（<span id="J_custom_num">0</span>）</a>
					<a href="javascript:;" data-index="1" class="J_tab_point cp-top-point">搜索结果</a>
				</div>
			</div>
			<div class="cp-bot touchsc">
				<div class="J_tab_cont ct-cont ct-chooses" style="display: block;" id="J_choose_custom"><p class="ct-emp">暂无选择信息</p></div>
				<div class="J_tab_cont ct-cont ct-search" id="J_search_custom"><p class="ct-emp">暂无搜索信息</p></div>
			</div>
		</div>
	</div>

	<!-- 裂变红包弹层 -->
	<div class="cm-pop cm-pop" id="J_pop_redpack">
		<a href="javascript:;" class="J_togglepop cm-pop-bg" data-target="#J_pop_redpack"></a>
		<div class="J_tabbox cm-pop-cont cm-pop-full-cont pop-custom">
			<div class="cp-top">
				<div class="cp-top-search">
					<input type="text" placeholder="输入裂变红包的名称搜索" class="J_blurscroll cp-top-input" id="J_redpack_input" />
					<a href="javascript:;" class="J_togglepop cp-top-close" data-target="#J_pop_redpack">关闭</a>
				</div>
			</div>
			<a href="javascript:;" class="cp-botbtn cm-blbtn gb-bgc" id="J_no_redpack">不关联裂变红包</a>
			<div class="redcou touchsc" id="J_scroll_redpack">
				<div class="rc-list" id="J_list_redpack">
					<!-- <a href="javascript:;" class="J_rc_item rc-item gb-oac">裂变红包1<p class="rc-tip gb-oac">线上券</p></a> -->
				</div>
				<div class="dsn empty" id="J_empty_redpack"><p><img src="assets/images/empty.png" class="emimg"></p><p class="emtext">暂无相关数据</p></div>
				<p class="botmore" id="J_botmore_redpack"><img src="assets/images/loading.gif" class="bmimg"><span class="load">正在加载更多···</span><span class="done">数据已全部加载完毕</span></p>
			</div>
		</div>
	</div>

	<!-- 活动券弹层 -->
	<div class="cm-pop cm-pop" id="J_pop_coupon">
		<a href="javascript:;" class="J_togglepop cm-pop-bg" data-target="#J_pop_coupon"></a>
		<div class="J_tabbox cm-pop-cont cm-pop-full-cont pop-custom">
			<div class="cp-top">
				<div class="cp-top-search">
					<input type="text" placeholder="输入线下/线上活动券的名称搜索" class="J_blurscroll cp-top-input" id="J_coupon_input" />
					<a href="javascript:;" class="J_togglepop cp-top-close" data-target="#J_pop_coupon">关闭</a>
				</div>
			</div>
			<a href="javascript:;" class="cp-botbtn cm-blbtn gb-bgc" id="J_no_coupon">不关联活动券</a>
			<div class="redcou touchsc" id="J_scroll_coupon">
				<div class="rc-list" id="J_list_coupon">
					<!-- <a href="javascript:;" class="J_rc_item rc-item gb-oac">裂变红包1<p class="rc-tip gb-oac">线上券</p></a> -->
				</div>
				<div class="dsn empty" id="J_empty_coupon"><p><img src="assets/images/empty.png" class="emimg"></p><p class="emtext">暂无相关数据</p></div>
				<p class="botmore" id="J_botmore_coupon"><img src="assets/images/loading.gif" class="bmimg"><span class="load">正在加载更多···</span><span class="done">数据已全部加载完毕</span></p>
			</div>
		</div>
	</div>


	<script language="javascript" type="text/javascript" src="./assets/js/jquery-2.1.4.min.js"></script>
	<script language="javascript" type="text/javascript" src="./assets/js/common.js"></script>
	<script language="javascript" type="text/javascript" src="./assets/js/vconsole.min.js"></script>
	<script type="text/javascript">
		$(function(){
			var data = {}; // 预定义提交对象，部分页面默认的数据也需对应设置好，此对象只是例子，根据具体需求变更***********************
			var locked = false; //设置开关  防止多次提交

			$('.redcou').css({height:window.innerHeight})


			var redpack_load = false, //关联红包下载状态
				coupon_load = false; //活动券下载状态
			$('.J_togglepop').click(function(){
				var tar = $($(this).attr('data-target')),
					type = $(this).attr('data-type')||'';
				tar.toggleClass('cm-pop-active');

				if(type=="redpack"&&!redpack_load){
					//关联红包弹层数据下载
					redpack_load = true
					getRedpackAjax(true);
				}
				if(type=="coupon"&&!coupon_load){
					//关联红包弹层数据下载
					coupon_load = true;
					getCouponAjax(true);
				}
			});

			//阅读积分输入绑定
			var J_reward = $('#J_reward');
			J_reward.on('focus',function(){
				var val = J_reward.val().trim();
				setTimeout(function(){
					J_reward.val(val)
				},0)
			}).on('blur',function(){
				var val = parseFloat(J_reward.val().trim())||0;
				J_reward.val(val)
				data.reward = val;
			})

			//其他设置开关事件
			$('.J_switch').click(function(){
				var self = $(this),
                    key = self.attr('data-key');
				if(self.hasClass('cm-switch-active')){
					self.removeClass('cm-switch-active');
					data[key] = false;
				}else{
					self.addClass('cm-switch-active');
					data[key] = true;
				}
			})

			//tab切换
			$('.J_tabbox').each(function(index,item){
				var elm = $(item),
					point = elm.find('.J_tab_point'),
					cont = elm.find('.J_tab_cont');
				point.click(function(){
					var idx = point.index($(this))
					$(this).addClass('active').siblings().removeClass('active');
					cont.hide().eq(idx).show()
				})
			})

			//设置发布员工
			var J_staff_num = $('#J_staff_num'),
				J_yuangong_input = $('#J_yuangong_input'),
				J_choose_staff = $('#J_choose_staff'),
				J_search_staff = $('#J_search_staff'),
				J_ctrol_staff = $('#J_ctrol_staff');

			J_yuangong_input.on('blur',function(){
				var key = $(this).val().trim();
				if(key){
					$.ajax({ 
						type: "GET",
						url: "./api/callback.json?v="+(new Date().getTime()),
						data: {},
						dataType: "json",
						success: function(res){
							if(res.code==0){
								// 虚拟返回数据
								res.data = [
									{id:1,name:'张三'},{id:11,name:'李四'},{id:2,name:'王五'},{id:3,name:'松江'},{id:4,name:'武松'},{id:5,name:'鲁智深'},{id:6,name:'燕青'},{id:7,name:'卢俊义'},
									{id:8,name:'公孙胜'},{id:9,name:'呼延灼'},{id:10,name:'阮小二'}
								]

								let str = '',
									chooseids = getChooseIds('staff');
								for(var i=0;i<res.data.length;i++){
									let item = res.data[i],
										ischoose = chooseids.indexOf(''+item.id)>-1?true:false;

									str += '<div class="ct-citem">'+item.name+'<a href="javascript:;" id="J_staffid_'+item.id+'" data-id="'+item.id+'" data-name="'+item.name+'" class="J_ct_add ct-do '+(ischoose?'disabled':'')+'">'+(ischoose?'已添加':'<i class="iconfont icon-plus01"></i>添加')+'</a></div>'
								}


								J_search_staff.html(str?str:'<p class="ct-emp">暂无搜索信息</p>')
								$('#J_pop_staff').find('.J_tab_point').eq(1).click();
							}else{
								CUES.alert({"msg":"此处可设置提示错误信息"})
							};
						}
					});

				}else{
					CUES.tip({msg:'请输入姓名'})
				}
			})
			//选择发布员工
			J_search_staff.on('click','.J_ct_add',function(){
				let self = $(this),
					id = self.attr('data-id'),
					name = self.attr('data-name');
				if(!self.hasClass('disabled')){
					self.addClass('disabled').html('已添加')
					addStaff({id:id,name:name});
				}
			})
			//移除发布员工
			J_choose_staff.on('click','.J_ct_del',function(){
				var idx = parseInt($(this).attr('data-index')),
					id = data.staff.splice(idx,1)[0].id;
				
				$('#J_staffid_'+id).removeClass('disabled').html('<i class="iconfont icon-plus01"></i>添加')
				resetDomStaff();
			})
			//添加发布员工
			function addStaff(item){
				data.staff = data.staff||[];
				data.staff.push(item);
				resetDomStaff();
			}
			//组合已选员工dom
			function resetDomStaff(){
				let list = data.staff||[],
					str = '';
				J_staff_num.html(list.length||0)
				J_ctrol_staff.val(list.length?'已选（'+list.length+'）人':'')
				for(var i=0;i<list.length;i++){
					let item = list[i];
					str += '<div class="ct-citem">'+item.name+'<a href="javascript:;" data-index="'+i+'" class="J_ct_del ct-do"><i class="iconfont icon-del01"></i>移除</a></div>'
				}
				J_choose_staff.html(str||'<p class="ct-emp">暂无选择信息</p>')
			}
			//获取选中对象id
			function getChooseIds(key){
				var list = data[key]||[],
					res = [];
				for(var i=0;i<list.length;i++){
					res.push(list[i].id)
				}
				return res
			}


			//设置发布部门
			var J_branch_num = $('#J_branch_num'),
				J_branch_input = $('#J_branch_input'),
				J_choose_branch = $('#J_choose_branch'),
				J_search_branch = $('#J_search_branch'),
				J_ctrol_branch = $('#J_ctrol_branch');
			J_branch_input.on('blur',function(){
				var key = $(this).val().trim();
				if(key){
					$.ajax({ 
						type: "GET",
						url: "./api/callback.json?v="+(new Date().getTime()),
						data: {},
						dataType: "json",
						success: function(res){
							if(res.code==0){
								// 虚拟返回数据
								res.data = [
									{id:1,name:'用友秉均',parent:'用友秉均'},
									{id:11,name:'运营事业部',parent:'用友秉均 > 运营事业部'},
									{id:2,name:'直销1组',parent:'用友秉均 > 直销事业部 > 直销1组'},
									{id:3,name:'直销2组',parent:'用友秉均 > 直销事业部 > 直销2组'},
									{id:4,name:'直销突击队1队',parent:'用友秉均 > 直销事业部 > 直销1组 > 直销突击队1队用友秉均 > 直销事业部 > 直销1组 > 直销突击队1队'}
								]

								let str = '',
									chooseids = getChooseIds('branch');
								for(var i=0;i<res.data.length;i++){
									let item = res.data[i],
										ischoose = chooseids.indexOf(''+item.id)>-1?true:false;

									str += '<div class="ct-citem">\
											<p class="bra-item">\
												'+item.name+'\
												<a href="javascript:;" id="J_branchid_'+item.id+'" data-id="'+item.id+'" data-name="'+item.name+'" data-parent="'+item.parent+'" class="J_ct_add ct-do '+(ischoose?'disabled':'')+'">'+(ischoose?'已添加':'<i class="iconfont icon-plus01"></i>添加')+'</a>\
											</p>\
											<p class="bra-item-dc">'+item.parent+'</p>\
										</div>'
								}


								J_search_branch.html(str?str:'<p class="ct-emp">暂无搜索信息</p>')
								$('#J_pop_branch').find('.J_tab_point').eq(1).click();
							}else{
								CUES.alert({"msg":"此处可设置提示错误信息"})
							};
						}
					});

				}else{
					CUES.tip({msg:'请输入部门'})
				}
			})
			//选择发布部门
			J_search_branch.on('click','.J_ct_add',function(){
				let self = $(this),
					id = self.attr('data-id'),
					name = self.attr('data-name'),
					parent = self.attr('data-parent');

				if(!self.hasClass('disabled')){
					self.addClass('disabled').html('已添加')
					addBranch({id:id,name:name,parent:parent});
				}
			})
			//移除发布部门
			J_choose_branch.on('click','.J_ct_del',function(){
				var idx = parseInt($(this).attr('data-index')),
					id = data.branch.splice(idx,1)[0].id;
				
				$('#J_branchid_'+id).removeClass('disabled').html('<i class="iconfont icon-plus01"></i>添加')
				resetDombranch();
			}).on('click','.J_ct_include',function(){
				//是否包含
				var idx = parseInt($(this).attr('data-index'));
				if($(this).hasClass('checked')){
					$(this).removeClass('checked')
					data.branch[idx].include = false;
				}else{
					$(this).addClass('checked')
					data.branch[idx].include = true;
				}
			})
			//添加发布部门
			function addBranch(item){
				data.branch = data.branch||[];
				data.branch.push(item);
				resetDombranch();
			}
			//组合已选部门dom
			function resetDombranch(){
				let list = data.branch||[],
					str = '';
				J_branch_num.html(list.length||0)
				J_ctrol_branch.val(list.length?'已选部门（'+list.length+'）':'')
				for(var i=0;i<list.length;i++){
					let item = list[i];
					str += '<div class="ct-citem">\
							<p class="bra-item">\
								'+item.name+'\
								<a href="javascript:;" data-index="'+i+'" class="J_ct_include ct-inc '+(item.include?'checked':'')+'"><i class="iconfont icon-check05"></i><i class="iconfont icon-check05h gb-c"></i>包含子部门</a>\
								<a href="javascript:;" data-index="'+i+'" class="J_ct_del ct-do"><i class="iconfont icon-del01"></i>移除</a>\
							</p>\
							<p class="bra-item-dc">'+item.parent+'</p>\
						</div>'
				}
				J_choose_branch.html(str||'<p class="ct-emp">暂无选择信息</p>')
			}

			//设置发布部门
			var J_custom_num = $('#J_custom_num'),
				J_custom_input = $('#J_custom_input'),
				J_choose_custom = $('#J_choose_custom'),
				J_search_custom = $('#J_search_custom'),
				J_ctrol_custom = $('#J_ctrol_custom');
			J_custom_input.on('blur',function(){
				var key = $(this).val().trim();
				if(key){
					$.ajax({ 
						type: "GET",
						url: "./api/callback.json?v="+(new Date().getTime()),
						data: {},
						dataType: "json",
						success: function(res){
							if(res.code==0){
								// 虚拟返回数据
								res.data = [
									{id:1,name:'自定义组织01'},{id:11,name:'自定义组织02'},{id:2,name:'自定义组织03'},{id:3,name:'自定义组织04'},{id:4,name:'自定义组织05'},{id:5,name:'自定义组织06'},{id:6,name:'自定义组织07'},{id:7,name:'自定义组织08'},
								]

								let str = '',
									chooseids = getChooseIds('custom');
								for(var i=0;i<res.data.length;i++){
									let item = res.data[i],
										ischoose = chooseids.indexOf(''+item.id)>-1?true:false;

									str += '<div class="ct-citem">'+item.name+'<a href="javascript:;" id="J_customid_'+item.id+'" data-id="'+item.id+'" data-name="'+item.name+'" class="J_ct_add ct-do '+(ischoose?'disabled':'')+'">'+(ischoose?'已添加':'<i class="iconfont icon-plus01"></i>添加')+'</a></div>'
								}


								J_search_custom.html(str?str:'<p class="ct-emp">暂无搜索信息</p>')
								$('#J_pop_custom').find('.J_tab_point').eq(1).click();
							}else{
								CUES.alert({"msg":"此处可设置提示错误信息"})
							};
						}
					});
				}else{
					CUES.tip({msg:'请输入姓名'})
				}
			})
			//选择发布自定义组织
			J_search_custom.on('click','.J_ct_add',function(){
				let self = $(this),
					id = self.attr('data-id'),
					name = self.attr('data-name'),
					parent = self.attr('data-parent');

				if(!self.hasClass('disabled')){
					self.addClass('disabled').html('已添加')
					addCustom({id:id,name:name,parent:parent});
				}
			})
			//移除发布自定义组织
			J_choose_custom.on('click','.J_ct_del',function(){
				var idx = parseInt($(this).attr('data-index')),
					id = data.custom.splice(idx,1)[0].id;
				
				$('#J_customid_'+id).removeClass('disabled').html('<i class="iconfont icon-plus01"></i>添加')
				resetDomcustom();
			})
			//添加发布自定义组织
			function addCustom(item){
				data.custom = data.custom||[];
				data.custom.push(item);
				resetDomcustom();
			}
			//组合已选员工dom
			function resetDomcustom(){
				let list = data.custom||[],
					str = '';
				J_custom_num.html(list.length||0)
				J_custom_num.html(list.length||0)
				J_ctrol_custom.val(list.length?'已选组织（'+list.length+'）':'')
				for(var i=0;i<list.length;i++){
					let item = list[i];
					str += '<div class="ct-citem">'+item.name+'<a href="javascript:;" data-index="'+i+'" class="J_ct_del ct-do"><i class="iconfont icon-del01"></i>移除</a></div>'
				}
				J_choose_custom.html(str||'<p class="ct-emp">暂无选择信息</p>')
			}

			//裂变红包滚动相关脚本
			var params_redpack = {pageNo:1,pageSize:40,key:''};
			var J_list_redpack = $('#J_list_redpack'),
				J_botmore_redpack = $('#J_botmore_redpack'),
				J_empty_redpack = $('#J_empty_redpack'),
				J_ctrol_redpack = $('#J_ctrol_redpack');

			var red_scroll = new jqELmMore({
				elm:'J_scroll_redpack',
				delay:500,
				callback:function(){
					params_redpack.pageNo++;
					getRedpackAjax();
				}
			})

			function getRedpackAjax(first){
				if(first){
					params_redpack.pageNo.page = 1;
					J_botmore_redpack.show().attr('class','botmore');
					J_empty_redpack.hide();
					J_list_redpack.html(''); //清空列表
				};
				// ajax获取列表数据
				red_scroll.stop = true; // 关闭下拉加载
				$.ajax({ 
					type: "GET",
					url: "./api/callback.json?v="+(new Date().getTime()),
					data: {},
					dataType: "json",
					success: function(res){
						if(res.code==0){
							// 虚拟返回40条数据
							res.data = [];
							for(var i=0;i<40;i++){
								res.data.push({id:Math.random(),name:'裂变红包'+i})
							}
							// 模拟加载完成
							if(params_redpack.pageNo>=2){
								res.data.splice(2,10)
							}
							//模拟空数据
							if(params_redpack.key.length>3){
								res.data = [];
							}

							var dt = res.data,len = dt.length,str = '';
							for(var i=0;i<len;i++){
								var v = dt[i];
								str += '<a href="javascript:;" class="J_red_item rc-item gb-oac" data-id="'+v.id+'" data-name="'+v.name+'">'+v.name+'<i class="iconfont icon-check04"></i></a>'
							};
							
							J_list_redpack.append(str);
							setTimeout(function(){
								red_scroll.stop = false; // 打开下拉加载
								if(len<params_redpack.pageSize){// 判断返回数据是否是全部数据
									if(data.page==1&&len==0){
										J_botmore_redpack.hide();
										J_empty_redpack.show()
									}else{
										J_botmore_redpack.attr('class','botmore botmore-all');
										J_empty_redpack.hide()
									}
									red_scroll.stop = true; // 关闭下拉加载
								};
							},30);
						}else{
							CUES.alert({"msg":"此处可设置提示错误信息"})
						};
					}
				});
			}
			//红包数据绑定选择和取消事件
			J_list_redpack.on('click','.J_red_item',function(){
				let self = $(this),
					id = self.attr('data-id'),
					name = self.attr('data-name');
				if(!self.hasClass('active')){
					J_ctrol_redpack.val(name);
					data.redpack = {id:id,name:name};
					self.addClass('active').siblings().removeClass('active')
				}
			})
			$('#J_no_redpack').click(function(){
				J_ctrol_redpack.val('');
				data.redpack = null;
				$('.J_red_item.active').removeClass('active');
				$('#J_pop_redpack').removeClass('cm-pop-active')
			})
			$('#J_redpack_input').on('blur',function(){
				var key = $(this).val().trim();
				if(key == params_redpack.key) return;
				params_redpack.key = key;
				getRedpackAjax(true);
			})

			//裂变红包滚动相关脚本
			var params_coupon = {pageNo:1,pageSize:40,key:''};
			var J_list_coupon = $('#J_list_coupon'),
				J_botmore_coupon = $('#J_botmore_coupon'),
				J_empty_coupon = $('#J_empty_coupon'),
				J_ctrol_coupon = $('#J_ctrol_coupon');

			var cou_scroll = new jqELmMore({
				elm:'J_scroll_coupon',
				delay:500,
				callback:function(){
					params_coupon.pageNo++;
					getCouponAjax();
				}
			})

			function getCouponAjax(first){
				if(first){
					params_coupon.pageNo.page = 1;
					J_botmore_coupon.show().attr('class','botmore');
					J_empty_coupon.hide();
					J_list_coupon.html(''); //清空列表
				};
				// ajax获取列表数据
				cou_scroll.stop = true; // 关闭下拉加载
				$.ajax({ 
					type: "GET",
					url: "./api/callback.json?v="+(new Date().getTime()),
					data: {},
					dataType: "json",
					success: function(res){
						console.log(23232)
						if(res.code==0){
							// 虚拟返回40条数据
							res.data = [];
							for(var i=0;i<40;i++){
								res.data.push({id:Math.random(),name:'活动券'+i,isline:Math.random()<.5?true:false})
							}
							// 模拟加载完成
							if(params_coupon.pageNo>=2){
								res.data.splice(2,10)
							}
							//模拟空数据
							if(params_coupon.key.length>3){
								res.data = [];
							}

							var dt = res.data,len = dt.length,str = '';
							for(var i=0;i<len;i++){
								var v = dt[i];
								str += '<a href="javascript:;" class="J_cou_item rc-item gb-oac" data-id="'+v.id+'" data-name="'+v.name+'">'+v.name+'<i class="iconfont icon-check04"></i><p class="rc-tip gb-oac">'+(v.isline?'线上券':'线下券')+'</p></a>'
							};
							console.log(4545)
							J_list_coupon.append(str);
							setTimeout(function(){
								cou_scroll.stop = false; // 打开下拉加载
								if(len<params_coupon.pageSize){// 判断返回数据是否是全部数据
									if(data.page==1&&len==0){
										J_botmore_coupon.hide();
										J_empty_coupon.show()
									}else{
										J_botmore_coupon.attr('class','botmore botmore-all');
										J_empty_coupon.hide()
									}
									cou_scroll.stop = true; // 关闭下拉加载
								};
							},30);
						}else{
							CUES.alert({"msg":"此处可设置提示错误信息"})
						};
					}
				});
			}
			//红包数据绑定选择和取消事件
			J_list_coupon.on('click','.J_cou_item',function(){
				let self = $(this),
					id = self.attr('data-id'),
					name = self.attr('data-name');
				if(!self.hasClass('active')){
					J_ctrol_coupon.val(name);
					data.coupon = {id:id,name:name};
					self.addClass('active').siblings().removeClass('active')
				}
			})
			$('#J_no_coupon').click(function(){
				J_ctrol_coupon.val('');
				data.coupon = null;
				$('.J_red_item.active').removeClass('active');
				$('#J_pop_coupon').removeClass('cm-pop-active')
			})
			$('#J_coupon_input').on('blur',function(){
				var key = $(this).val().trim();
				if(key == params_coupon.key) return;
				params_coupon.key = key;
				getCouponAjax(true);
			})






			//发布
			$('#J_save').click(function(){
				if(!data.staff||!data.staff.length){
					CUES.tip({msg:'请设置发送员工'})
					return;
				}
				if(!data.branch||!data.branch.length){
					CUES.tip({msg:'请设置发送部门'})
					return;
				}
				if(!data.custom||!data.custom.length){
					CUES.tip({msg:'请设置发送自定义组织'})
					return;
				}

				locked = true;
				CUES.loading({msg:'正在发布，请稍等...'})
				//模拟ajax请求延时
				setTimeout(function(){
					CUES.loadingclose()
					CUES.tip({msg:'已提交发布，请稍后进入活动中心查看',type:'success',callback:function(){
						// window.location.href = './1019publish_form.html'
					}})
				},1500)
			})


			
		});
	</script>
</body>
</html>
